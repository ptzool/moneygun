<% content_for :title, "Task Timetrackings Calendar" %>
<% content_for :head do %>
  <!-- Direct FullCalendar CDN links -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.0/main.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.0/main.min.js"></script>
  
  <style>
    .fc-theme-standard td, .fc-theme-standard th {
      border: 1px solid #ddd;
    }
    .fc .fc-daygrid-day-number {
      padding: 4px;
    }
    .fc .fc-col-header-cell-cushion {
      padding: 8px 4px;
    }
    
    /* Selected day styling */
    .selected-date {
      background-color: rgba(66, 153, 225, 0.2) !important;
      border: 2px solid #4299e1 !important;
    }
    
    .work-day {
      background-color: rgba(72, 187, 120, 0.2) !important;
    }
    
    .vacation-day {
      background-color: rgba(66, 153, 225, 0.2) !important;
    }
    
    .sick-day {
      background-color: rgba(237, 100, 100, 0.2) !important;
    }
    
    /* Calendar hover effects */
    .fc-day:hover {
      background-color: rgba(200, 200, 200, 0.2);
      cursor: pointer;
    }
    
    /* Badge styling */
    .badge {
      padding: 2px 6px;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 500;
    }
    
    .bg-success {
      background-color: #48bb78;
    }
    
    .bg-primary {
      background-color: #4299e1;
    }
    
    .bg-danger {
      background-color: #ed6464;
    }
    
    .bg-secondary {
      background-color: #718096;
    }
    
    .text-white {
      color: white;
    }
    
    /* Modal styling */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      z-index: 1050;
      width: 100%;
      height: 100%;
      overflow: hidden;
      outline: 0;
      background-color: rgba(0, 0, 0, 0.5);
      display: none;
    }
    
    .modal.show {
      display: block;
    }
    
    .modal-dialog {
      position: relative;
      width: auto;
      margin: 1.75rem auto;
      max-width: 500px;
      pointer-events: none;
    }
    
    .modal-content {
      position: relative;
      display: flex;
      flex-direction: column;
      width: 100%;
      pointer-events: auto;
      background-color: #fff;
      background-clip: padding-box;
      border: 1px solid rgba(0, 0, 0, 0.2);
      border-radius: 0.3rem;
      outline: 0;
    }
    
    .modal-header {
      display: flex;
      flex-shrink: 0;
      align-items: center;
      justify-content: space-between;
      padding: 1rem;
      border-bottom: 1px solid #dee2e6;
      border-top-left-radius: calc(0.3rem - 1px);
      border-top-right-radius: calc(0.3rem - 1px);
    }
    
    .modal-body {
      position: relative;
      flex: 1 1 auto;
      padding: 1rem;
    }
    
    .modal-footer {
      display: flex;
      flex-wrap: wrap;
      flex-shrink: 0;
      align-items: center;
      justify-content: flex-end;
      padding: 0.75rem;
      border-top: 1px solid #dee2e6;
      border-bottom-right-radius: calc(0.3rem - 1px);
      border-bottom-left-radius: calc(0.3rem - 1px);
    }
    
    /* Alert styling */
    .alert {
      padding: 1rem;
      margin-bottom: 1rem;
      border: 1px solid transparent;
      border-radius: 0.25rem;
    }
    
    .alert-success {
      color: #155724;
      background-color: #d4edda;
      border-color: #c3e6cb;
    }
  </style>
<% end %>

<%= render "shared/confirmation_modal" %>

<%= render PageComponent.new(title: "Time Tracking Calendar for #{@task.name}") do |component| %>
  <% component.with_action_list do %>
    <%= link_to "New Time Entry", new_organization_task_task_timetracking_path(@organization, @task), class: "btn btn-primary" %>
    <%= link_to "List View", organization_task_task_timetrackings_path(@organization, @task), class: "btn btn-secondary" %>
    <%= link_to "Back to Task", organization_task_path(@organization, @task), class: "btn btn-secondary" %>
    <%= button_tag "Bulk Edit", type: "button", class: "btn btn-primary", data: { action: "click->calendar-timetracking#showBulkEditModal" } %>
  <% end %>

  <div class="card shadow mt-4 mb-4">
    <div class="card-body bg-light">
      <h4 class="font-medium text-lg mb-2">Calendar Usage Instructions:</h4>
      <ul class="list-disc pl-5 space-y-1 text-sm">
        <li><strong>Single click</strong> on a day to add a new time entry</li>
        <li><strong>Shift+click</strong> on days to select multiple days for bulk editing</li>
        <li>Use the <strong>Bulk Edit</strong> button to apply work/vacation/sick days to selected dates</li>
        <li>Click on an existing time entry to view or edit details</li>
      </ul>
    </div>
  </div>

  <div class="card shadow mt-4" data-controller="calendar-timetracking" data-calendar-timetracking-organization-id-value="<%= @organization.id %>" data-calendar-timetracking-task-id-value="<%= @task.id %>" id="calendar-container" data-turbo="false">
    <% if notice %>
      <div class="alert alert-success" role="alert">
        <%= notice %>
      </div>
    <% end %>
    <div class="card-body">
      <div class="flex justify-between items-center mb-4">
              <div class="flex-1">
                <h3 class="text-lg font-semibold" data-calendar-timetracking-target="calendarTitle">Time Entries Calendar for <%= @task.name %></h3>
              </div>
        <div class="flex space-x-2">
          <button type="button" class="btn btn-sm btn-secondary" data-action="click->calendar-timetracking#previous">
            « Previous
          </button>
          <button type="button" class="btn btn-sm btn-secondary" data-action="click->calendar-timetracking#today">
            Today
          </button>
          <button type="button" class="btn btn-sm btn-secondary" data-action="click->calendar-timetracking#next">
            Next »
          </button>
        </div>
      </div>
      
      <div id="calendar" data-calendar-timetracking-target="calendar" data-calendar-url="<%= calendar_organization_task_task_timetrackings_path(@organization, @task, format: :json) %>"></div>
      
      <script>
              document.addEventListener('DOMContentLoaded', function() {
                // Initialize the form validation for the modal form
                const modalForm = document.getElementById('time-entry-form');
                const errorDiv = document.getElementById('form-errors');
                
                if (modalForm) {
                  modalForm.addEventListener('submit', function(event) {
                    const durationField = modalForm.querySelector('input[name*="[duration_in_hours]"]');
                    
                    if (durationField && parseFloat(durationField.value) <= 0) {
                      event.preventDefault();
                      errorDiv.textContent = "Duration must be greater than zero.";
                      errorDiv.classList.remove('hidden');
                      return false;
                    }
                    
                    errorDiv.classList.add('hidden');
                  });
                }
                
                // Fallback initialization in case the Stimulus controller fails
                setTimeout(function() {
                  const calendarEl = document.getElementById('calendar');
                  if (calendarEl && !calendarEl.innerHTML && typeof FullCalendar !== 'undefined') {
                    console.log("Initializing fallback calendar");
                    const calendar = new FullCalendar.Calendar(calendarEl, {
                      initialView: 'dayGridMonth',
                      headerToolbar: {
                        left: 'prev,next today',
                        center: 'title',
                        right: 'dayGridMonth'
                      },
                      events: calendarEl.dataset.calendarUrl,
                      dateClick: function(info) {
                        const modal = document.getElementById('timeEntryModal');
                        const dateField = document.querySelector('[data-calendar-timetracking-target="dateField"]');
                        if (dateField) {
                          dateField.value = info.dateStr;
                        }
                        if (modal) {
                          modal.classList.add('show');
                          modal.style.display = 'block';
                        }
                      },
                      selectable: true
                    });
                    calendar.render();
                  }
                }, 1000);
              });
            </script>
    </div>
  </div>

  <!-- Time Entry Modal -->
  <div class="modal" id="timeEntryModal" tabindex="-1" aria-labelledby="timeEntryModalLabel" aria-hidden="true" data-calendar-timetracking-target="modal" style="z-index: 1060;" data-turbo="false">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="timeEntryModalLabel">Add Time Entry</h5>
          <button type="button" class="btn-close" aria-label="Close" data-action="click->calendar-timetracking#hideModal">&times;</button>
        </div>
        <div class="modal-body">
          <%= form_with(model: [ @organization, @task, @task_timetracking ], class: "contents space-y-4", data: { controller: "time-entry-form", action: "submit->calendar-timetracking#submitForm", turbo: false }, id: "time-entry-form") do |form| %>
            <%= render "shared/errors", object: form.object %>
            
            <%= form.hidden_field :task_id, value: @task.id %>
            
            <div class="grid grid-cols-1 gap-4">
              <div>
                <%= form.label :date, class: "block text-sm font-medium text-gray-700 mb-1" %>
                <%= form.date_field :date, class: "form-input w-full", data: { "calendar-timetracking-target": "dateField" } %>
              </div>
              
              <div>
                <%= form.label :start, "Start Time", class: "block text-sm font-medium text-gray-700 mb-1" %>
                <%= form.time_field :start, class: "form-input w-full", value: Time.new(2000, 1, 1, 9, 0).strftime("%H:%M"), data: { action: "change->time-entry-form#updateDuration input->time-entry-form#updateDuration" } %>
              </div>
              
              <div>
                <%= form.label :end, "End Time", class: "block text-sm font-medium text-gray-700 mb-1" %>
                <%= form.time_field :end, class: "form-input w-full", value: Time.new(2000, 1, 1, 17, 0).strftime("%H:%M"), data: { action: "change->time-entry-form#updateDuration input->time-entry-form#updateDuration" } %>
              </div>
              
              <div>
                <%= form.label :duration_in_hours, "Duration (hours)", class: "block text-sm font-medium text-gray-700 mb-1" %>
                <div class="flex items-center">
                  <%= form.number_field :duration_in_hours, class: "form-input w-full", step: 0.25, min: 0.25, value: 8.0, data: { action: "input->time-entry-form#updateTimes change->time-entry-form#updateTimes" } %>
                  <span class="ml-2 text-sm text-gray-600">hours</span>
                </div>
                <p class="text-sm text-gray-500 mt-1">Enter time directly or use start/end times</p>
              </div>
              
              <div id="form-errors" class="text-red-500 bg-red-100 p-3 rounded hidden"></div>
            </div>

            <div class="flex justify-end mt-4">
              <button type="button" class="btn btn-secondary mr-2" data-action="click->calendar-timetracking#hideModal">Cancel</button>
              <%= form.submit "Save Time Entry", class: "btn btn-primary", data: { disable_with: "Saving..." } %>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <!-- Bulk Edit Modal -->
  <div class="modal" id="bulkEditModal" tabindex="-1" aria-labelledby="bulkEditModalLabel" aria-hidden="true" data-calendar-timetracking-target="bulkEditModal" style="z-index: 1060;" data-turbo="false">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="bulkEditModalLabel">Bulk Edit Time Entries</h5>
          <button type="button" class="btn-close" aria-label="Close" data-action="click->calendar-timetracking#hideBulkEditModal">&times;</button>
        </div>
        <div class="modal-body">
          <div class="mb-4">
            <p class="text-sm text-gray-600 mb-2">Select day type to apply to selected days (shift+click to select days):</p>
            <div class="flex space-x-2">
              <button type="button" class="btn btn-sm btn-success" data-action="click->calendar-timetracking#applyWorkDay">Work Day</button>
              <button type="button" class="btn btn-sm btn-primary" data-action="click->calendar-timetracking#applyVacationDay">Vacation Day</button>
              <button type="button" class="btn btn-sm btn-danger" data-action="click->calendar-timetracking#applySickDay">Sick Day</button>
            </div>
          </div>
          
          <div class="mb-4">
            <p class="text-sm text-gray-600 mb-2">Apply standard hours:</p>
            <div class="flex space-x-2">
              <button type="button" class="btn btn-sm btn-secondary" data-action="click->calendar-timetracking#applyStandardHours" data-hours="8">8 hours</button>
              <button type="button" class="btn btn-sm btn-secondary" data-action="click->calendar-timetracking#applyStandardHours" data-hours="4">4 hours</button>
              <button type="button" class="btn btn-sm btn-secondary" data-action="click->calendar-timetracking#clearHours">Clear</button>
            </div>
          </div>
          
          <div class="mt-6">
            <h6 class="font-medium">Selected Days: <small class="text-muted">(hold Shift key and click on calendar to select days)</small></h6>
            <div data-calendar-timetracking-target="selectedDays" class="mt-2 p-2 border rounded max-h-40 overflow-y-auto">
              <p class="text-gray-500 text-sm italic">No days selected. Hold Shift key and click on calendar days to select them.</p>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-action="click->calendar-timetracking#hideBulkEditModal">Cancel</button>
          <button type="button" class="btn btn-primary" data-action="click->calendar-timetracking#submitBulkEdit">Apply Changes</button>
        </div>
      </div>
    </div>
  </div>
<% end %>